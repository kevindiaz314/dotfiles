#!/usr/bin/env fish

{{ if eq .chezmoi.os "linux" -}}
# CachyOS Package Installation Script
# This script declaratively installs packages for CachyOS setup
# Uses Fish shell syntax since CachyOS comes with Fish as default

echo "üöÄ Starting CachyOS package installation..."

# Update system first
echo "üì¶ Updating system packages..."
sudo pacman -Syu --noconfirm

# Terminal & Shell Tools
echo "üîß Installing terminal and shell tools..."
sudo pacman -S --needed --noconfirm \
    atuin \
    zoxide \
    lazygit \
    zellij \
    yazi \
    chafa \
    satty

# System Configuration Tools
echo "‚öôÔ∏è  Installing system configuration tools..."
sudo pacman -S --needed --noconfirm \
    wl-clipboard \
    7zip \
    resvg \
    playerctl \
    cava \
    brightnessctl \
    libva-utils \
    keyd \
    tailscale

# Hyprland & Desktop Environment
# echo "ü™ü Installing Hyprland and desktop environment packages..."
# sudo pacman -S --needed --noconfirm \
#     hyprland \
#     hyprsunset \
#     uwsm \
#     xdg-desktop-portal-hyprland

# Niri compositor
echo "üåä Installing Niri compositor..."
sudo pacman -S --needed --noconfirm \
    niri \
    xdg-desktop-portal-kde \
    dolphin \
    xwayland-satellite

# Applications
echo "üéØ Installing applications..."
sudo pacman -S --needed --noconfirm \
    nextcloud-client \
    kwallet \
    kwalletmanager \
    ghostty \
    obsidian \
    vesktop \
    zen-browser-bin \
    chromium \
    obs-studio-browser \
    spotify-launcher \
    zed \
    yubico-authenticator

# Development Tools
echo "üíª Installing development tools..."
sudo pacman -S --needed --noconfirm \
    neovim \
    npm \
    go \
    hugo

# AUR Packages (using paru which comes with CachyOS by default)
echo "üì¶ Installing AUR packages..."
paru -S --needed --noconfirm \
    oh-my-posh-bin \
    visual-studio-code-bin \
    cursor-bin \
    kiro-bin \
    slack-desktop-wayland \
    vicinae-bin \
    quickshell-git

# Enable and start system services
echo "üîß Enabling system services..."

# Enable keyd service for keyboard remapping (idempotent)
if not systemctl is-enabled keyd.service > /dev/null 2>&1
    echo "Enabling keyd service..."
    sudo systemctl enable --now keyd.service
else
    echo "keyd service already enabled"
end

# Enable tailscale (idempotent)
if not systemctl is-enabled tailscaled.service > /dev/null 2>&1
    echo "Enabling tailscale service..."
    sudo systemctl enable --now tailscaled.service
else
    echo "tailscale service already enabled"
end

# Enable user services
echo "üë§ Enabling user services..."
if not systemctl --user is-enabled ssh-agent.service > /dev/null 2>&1
    echo "Enabling ssh-agent user service..."
    systemctl --user enable --now ssh-agent.service
else
    echo "ssh-agent service already enabled"
end

# Setup keyd configuration
echo "‚å®Ô∏è  Setting up keyd configuration..."
if test ! -f /etc/keyd/default.conf
    echo "Creating keyd configuration..."
    echo '[ids]

0001:0001:70533846

[main]

# Maps capslock to escape when pressed and control when held.
capslock = overload(control, esc)

# Remaps the escape key to capslock
esc = capslock

# Swap alt and control
leftalt = leftcontrol
leftcontrol = leftalt' | sudo tee /etc/keyd/default.conf
else
    echo "keyd configuration already exists"
end

# NPM global directory setup
echo "üì¶ Setting up NPM global directory..."
if test ! -d ~/.npm-global
    mkdir ~/.npm-global
    npm config set prefix '~/.npm-global'
    echo "‚úÖ NPM global directory configured"
else
    echo "NPM global directory already configured"
end

# Install global NPM packages
echo "üì¶ Installing global NPM packages..."
set -l npm_packages "@google/gemini-cli" "opencode-ai"
for package in $npm_packages
    if not npm list -g $package > /dev/null 2>&1
        echo "Installing $package..."
        npm install -g $package
    else
        echo "$package already installed"
    end
end
echo "‚úÖ Package installation completed!"
{{ else -}}
echo "‚ùå This script is designed for Linux (CachyOS). Current OS: {{ .chezmoi.os }}"
exit 1
{{ end -}}
